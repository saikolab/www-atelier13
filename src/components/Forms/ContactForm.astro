---
import Button from "@components/Button/Button.astro";
import type { Locale } from "@/i18n/config";
import { getLangFromUrl } from "@/i18n/utils";
import { t } from "@/i18n/ui";
interface Props { lang?: Locale }
const urlLang = getLangFromUrl(Astro.url);
const { lang = urlLang } = Astro.props as Props;
---

<form id="contact-form" name="contact" class="flex h-full flex-col justify-between gap-4" method="POST" action="/api/contact" novalidate>
	<input type="hidden" name="form-name" value="contact" />
  <!-- Honeypot field -->
  <input type="text" name="website" tabindex="-1" autocomplete="off" class="hidden" />
	<div>
    <label for="contact-name" class="font-heading-1 text-lg uppercase">{t(lang,'contactForm','name')}</label>
		<input type="text" class="form__input" name="name" id="contact-name" placeholder="" required />
	</div>
	<div class="flex flex-col gap-1">
    <label for="contact-email" class="font-heading-1 text-lg uppercase">{t(lang,'contactForm','email')}</label>
		<input
			type="email"
			class="form__input"
			name="email"
			id="contact-email"
			inputmode="email"
			placeholder=""
			required
		/>
	</div>
	<div>
    <label for="contact-date" class="font-heading-1 text-lg uppercase">{t(lang,'contactForm','date')}</label>
		<input type="date" class="form__input" name="date" id="contact-date" placeholder="" required />
	</div>
	<div>
    <label for="contact-message" class="font-heading-1 text-lg uppercase">{t(lang,'contactForm','message')}</label>
		<textarea
			name="message"
			class="form__input"
			id="contact-message"
			rows="6"
			placeholder=""
			required></textarea>
	</div>
	<div class="flex">
		<Button variant="primary" type="submit" class="w-full px-10 md:w-fit">{t(lang,'contactForm','submit')}</Button>
	</div>
  <p id="contact-status" class="mt-2 text-sm opacity-80"></p>
</form>

<!-- Turnstile widget -->
<div class="mt-2">
  <div class="cf-turnstile" data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || ''} data-theme="light"></div>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" defer></script>
  <script>
    const form = document.getElementById('contact-form');
    const statusEl = document.getElementById('contact-status');
    async function handleSubmit(e) {
      e.preventDefault();
      statusEl.textContent = '';
      const fd = new FormData(form);
      try {
        const res = await fetch(form.action, { method: 'POST', body: fd });
        const data = await res.json();
        if (data.ok) {
          statusEl.textContent = 'Thank you! We will get back to you shortly.';
          form.reset();
          if (window.turnstile) window.turnstile.reset();
        } else {
          statusEl.textContent = 'Submission failed. Please try again.';
        }
      } catch {
        statusEl.textContent = 'Network error. Please try again.';
      }
    }
    form?.addEventListener('submit', handleSubmit);
  </script>
</div>
